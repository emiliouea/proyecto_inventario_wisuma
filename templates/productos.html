{% extends "base.html" %} {% block title %}Productos - Ferretería Senguana{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2><i class="bi bi-box-seam"></i> Catálogo de Productos</h2>
    <p class="text-muted">
      Gestiona el inventario de productos disponibles en bodega
    </p>
  </div>
  <button
    class="btn btn-success"
    data-bs-toggle="modal"
    data-bs-target="#productModal"
    onclick="openProductModal()"
  >
    <i class="bi bi-plus-circle"></i> Agregar Producto
  </button>
</div>

{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%} {% for category, message in messages %}
<div
  class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show"
  role="alert"
>
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %} {% endif %} {% endwith %}

<!-- Filtros y Búsqueda -->
<div class="card mb-4">
  <div class="card-body">
    <form method="GET" class="row g-3">
      <div class="col-md-8">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input
            type="text"
            name="busqueda"
            class="form-control"
            placeholder="Buscar productos por nombre..."
            value="{{ busqueda_actual }}"
          />
          <button type="submit" class="btn btn-primary">Buscar</button>
          {% if busqueda_actual or categoria_actual %}
          <a href="{{ url_for('productos') }}" class="btn btn-secondary"
            >Limpiar</a
          >
          {% endif %}
        </div>
      </div>
    </form>

    <div class="mt-3">
      <span class="me-2"><strong>Categorías:</strong></span>
      {% for cat in categorias %}
      <a
        href="{{ url_for('productos', categoria=cat) }}"
        class="badge {% if categoria_actual == cat %}bg-primary{% else %}bg-secondary{% endif %} text-decoration-none me-1"
      >
        {{ cat }}
      </a>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Grid de Productos -->
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
  {% for producto in productos %}
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="card-title">{{ producto.nombre }}</h5>
          <span class="badge bg-info">{{ producto.codigo }}</span>
        </div>
        <p class="card-text">
          <span class="badge bg-secondary">{{ producto.categoria }}</span>
        </p>
        <h4 class="text-primary">${{ "%.2f"|format(producto.precio) }}</h4>
        <p class="mb-2">
          <strong>Stock:</strong>
          <span
            class="badge {% if producto.stock < 20 %}bg-warning text-dark{% else %}bg-success{% endif %}"
          >
            {{ producto.stock }} unidades
          </span>
        </p>
      </div>
      <div class="card-footer bg-transparent">
        <div class="btn-group w-100" role="group">
          <a
            href="{{ url_for('item', codigo=producto.codigo) }}"
            class="btn btn-sm btn-primary"
          >
            <i class="bi bi-eye"></i> Ver
          </a>
          <button
            class="btn btn-sm btn-info text-white"
            data-bs-toggle="modal"
            data-bs-target="#productModal"
            onclick="editProduct(this)"
            data-id="{{ producto.id }}"
            data-codigo="{{ producto.codigo }}"
            data-nombre="{{ producto.nombre }}"
            data-categoria="{{ producto.categoria }}"
            data-precio="{{ producto.precio }}"
            data-stock="{{ producto.stock }}"
            data-ubicacion="{{ producto.ubicacion }}"
            data-descripcion="{{ producto.descripcion }}"
          >
            <i class="bi bi-pencil"></i> Editar
          </button>
          <form
            method="POST"
            action="{{ url_for('producto_eliminar', producto_id=producto.id) }}"
            class="d-inline"
            onsubmit="
              return confirm('¿Está seguro de eliminar este producto?');
            "
          >
            <button type="submit" class="btn btn-sm btn-danger">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if productos|length == 0 %}
<div class="text-center py-5">
  <i class="bi bi-inbox display-1 text-muted"></i>
  <p class="lead">No hay productos registrados en el sistema.</p>
  <button
    class="btn btn-primary"
    data-bs-toggle="modal"
    data-bs-target="#productModal"
    onclick="openProductModal()"
  >
    <i class="bi bi-plus-circle"></i> Agregar Primer Producto
  </button>
</div>
{% endif %}

<!-- Modal Bootstrap para Agregar/Editar Producto -->
<div
  class="modal fade"
  id="productModal"
  tabindex="-1"
  aria-labelledby="modalTitle"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalTitle">Agregar Producto</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form
        id="productForm"
        method="POST"
        action="{{ url_for('producto_nuevo') }}"
      >
        <div class="modal-body">
          <input type="hidden" id="productId" name="product_id" />

          <div class="row g-3">
            <div class="col-md-6">
              <label for="codigo" class="form-label"
                >Código del Producto *</label
              >
              <input
                type="text"
                class="form-control"
                id="codigo"
                name="codigo"
                required
                placeholder="Ej: FER001"
              />
            </div>
            <div class="col-md-6">
              <label for="categoria" class="form-label">Categoría *</label>
              <input
                type="text"
                class="form-control"
                id="categoria"
                name="categoria"
                required
                list="categorias-list"
                placeholder="Ej: Herramientas"
              />
              <datalist id="categorias-list">
                {% for cat in categorias %}
                <option value="{{ cat }}">{% endfor %}</option>
              </datalist>
            </div>
            <div class="col-12">
              <label for="nombre" class="form-label"
                >Nombre del Producto *</label
              >
              <input
                type="text"
                class="form-control"
                id="nombre"
                name="nombre"
                required
                placeholder="Ej: Martillo de Carpintero"
              />
            </div>
            <div class="col-md-4">
              <label for="precio" class="form-label">Precio ($) *</label>
              <input
                type="number"
                class="form-control"
                id="precio"
                name="precio"
                step="0.01"
                min="0"
                required
                placeholder="0.00"
              />
            </div>
            <div class="col-md-4">
              <label for="stock" class="form-label">Stock (unidades) *</label>
              <input
                type="number"
                class="form-control"
                id="stock"
                name="stock"
                min="0"
                required
                placeholder="0"
              />
            </div>
            <div class="col-md-4">
              <label for="ubicacion" class="form-label">Ubicación</label>
              <input
                type="text"
                class="form-control"
                id="ubicacion"
                name="ubicacion"
                placeholder="Bodega A - Estante 3"
              />
            </div>
            <div class="col-12">
              <label for="descripcion" class="form-label">Descripción</label>
              <textarea
                class="form-control"
                id="descripcion"
                name="descripcion"
                rows="3"
                placeholder="Descripción detallada del producto..."
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function openProductModal() {
    document.getElementById("modalTitle").textContent = "Agregar Producto";
    document.getElementById("productForm").action =
      "{{ url_for('producto_nuevo') }}";
    document.getElementById("productForm").reset();
    document.getElementById("productId").value = "";
  }

  function editProduct(button) {
    const id = button.getAttribute("data-id");
    const codigo = button.getAttribute("data-codigo");
    const nombre = button.getAttribute("data-nombre");
    const categoria = button.getAttribute("data-categoria");
    const precio = button.getAttribute("data-precio");
    const stock = button.getAttribute("data-stock");
    const ubicacion = button.getAttribute("data-ubicacion");
    const descripcion = button.getAttribute("data-descripcion");

    document.getElementById("modalTitle").textContent = "Editar Producto";
    document.getElementById("productForm").action = `/productos/editar/${id}`;
    document.getElementById("productId").value = id;
    document.getElementById("codigo").value = codigo;
    document.getElementById("nombre").value = nombre;
    document.getElementById("categoria").value = categoria;
    document.getElementById("precio").value = precio;
    document.getElementById("stock").value = stock;
    document.getElementById("ubicacion").value = ubicacion || "";
    document.getElementById("descripcion").value = descripcion || "";
  }
</script>

{% endblock %}
